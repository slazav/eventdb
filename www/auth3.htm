<html>

<head>

<style>
body { font-family: arial,sans-serif; }

.main_menu, .user_fname, .user_alias, .user_rlevel, .user_level {
  font-family: arial,sans-serif;
  font-weight: bold;
}


.user_ppic {
  margin-bottom: -2px;
}
</style>

<script>
//
var providers = 'livejournal,facebook,vkontakte,yandex,google';
var evdb_url = 'http://slazav.mccme.ru/perl/auth3s.pl';
var lgnz_url = 'https://loginza.ru/api/widget?token_url=' + evdb_url
             + '&providers_set=' + providers;
document.cookie = "RETPAGE=" + document.URL;

// do eventdb request
function do_request(action, callback){
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState == 4 && xhttp.status == 200) {
      var data = JSON.parse(xhttp.responseText);
      if (data.error_type){ process_err(data); }
      else { callback(data);}
    }
  };
  xhttp.open("GET", evdb_url + '?action=' + action
                  + '&t=' + Math.random(), true);
  xhttp.send();
}

// process error
function process_err(data){
  alert(data.error_type + ": " + data.error_message);
}

// fill user data
function update_user_info(my_info){
  var lform = document.getElementById('login_box');
  if (my_info.session && my_info.alias){
    lform.innerHTML = '<span class="user_alias"></span> '
       + '<input type="submit" value="выйти" '
       + 'name="LogOut" onclick="do_logout()"/>';
    a = document.getElementsByClassName('user_alias');
    for (var i=0; i < a.length; i++){
      a[i].innerHTML = my_info.alias; }
    a = document.getElementsByClassName('user_level');
    for (var i=0; i < a.length; i++){
      a[i].innerHTML = my_info.level; }
    a = document.getElementsByClassName('user_rlevel');
    for (var i=0; i < a.length; i++){
      a[i].innerHTML = get_rlevel(my_info.level); }
    a = document.getElementsByClassName('user_fname');
    for (var i=0; i < a.length; i++){
      a[i].innerHTML = my_info.full_name; }
    a = document.getElementsByClassName('user_ppic');
    for (var i=0; i < a.length; i++){
      a[i].src = get_ppic(my_info.provider); }
    a = document.getElementsByClassName('user_href');
    for (var i=0; i < a.length; i++){
      a[i].href = my_info.identity; }
  } else {
    lform.innerHTML='<a href="' + lgnz_url + '">войти</a>';
  }
}

function do_init(){
  var lform = document.getElementById('login_box');
  lform.innerHTML='<a href="' + lgnz_url + '">войти</a>';
  do_request('my_info', update_user_info);
}

function do_logout(){
  do_request('logout', update_user_info);
}

function get_ppic(pr){
  if (pr == 'vk') return 'http://slazav.mccme.ru/lib/vk.png';
  if (pr == 'lj') return 'http://slazav.mccme.ru/lib/lj.gif';
  if (pr == 'fb') return 'http://slazav.mccme.ru/lib/fb.png';
  if (pr == 'yandex') return 'http://slazav.mccme.ru/lib/ya.png';
  if (pr == 'google') return 'http://slazav.mccme.ru/lib/gp.png';
  return null;
}

function get_rlevel(l){
  if (l == 'anon') return 'забаненный';
  if (l == 'norm') return 'обычный';
  if (l == 'moder') return 'модератор';
  if (l == 'admin') return 'администратор';
  return null;
}

</script>


</head>

<body>

  <table width="100%" border=0 class="main_menu"><tr>
  <td class=hh width="16.7%">Новости</td>
  <td class=hh width="16.7%">Походы</td>
  <td class=hh width="16.7%">Карта</td>
  <td class=hh width="16.7%">Люди</td>
  <td class=hh width="16.7%" id=login_box></td>
  </tr></table>
  <hr>

  <h4>Добро пожаловать!</h4>

  <script>
    // open/close the set alias form
    // fill if with a current alias name
    function ch_alias_form(){
      document.getElementById('ch_alias_text').value=
        document.getElementById('user_alias').innerHTML;
      document.getElementById('ch_alias_form').style.display=
        document.getElementById('ch_alias_form').style.display=="inline"?
          "none":"inline";
    }
    // ch_alias request + update all aliases on the page
    function ch_alias_do(){
      var newal = document.getElementById('ch_alias_text').value;
      do_request('set_alias ' + newal, function(my_info){
          a = document.getElementsByClassName('user_alias');
          for (var i=0; i < a.length; i++){ a[i].innerHTML = my_info.alias; }
        });
      ch_alias_form();
    }
  </script>

  <p>Вы -- <a class="user_href" style="text-decoration: none">
  <img class="user_ppic">&nbsp;<span class="user_fname"></span></a>,
     в социальных сетях про вас известно все!
  <br>Ваше имя на этом сайте:
     <span class="user_alias" id="user_alias"></span>.
     Вы можете поменять его, нажав на эту картинку:
     <img src="http://slazav.mccme.ru/lib/edit2.png" onclick="ch_alias_form()">
     <span id="ch_alias_form" style="display:none">
     <input id="ch_alias_text" type="text"
            name="new_alias" onchange="ch_alias_do()"></span>
  <br>Ваш уровень доступа: <span class="user_rlevel"></span>. Поменять ваш уровень
     доступа может пользователь с уровнем, большим, чем у вас.

  <p>уровни доступа:
  <ul>
  <li>Забаненный -- те же права, что и у анонимного пользователя.
  <li>Обычный -- любой новый пользователь.
  <li>Модератор -- может править чужие записи и банить обычных пользователей.
  <li>Администратор -- может назначать и свергать модераторов.
  </ul>

  <h4>Список пользователей</h4>
  <input type=submit name="sh_users" value="смотреть" onclick="sh_users()">

  <script> do_init() </script>
</body>
</html>
